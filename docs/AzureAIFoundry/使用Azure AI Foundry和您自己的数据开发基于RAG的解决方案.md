# 介绍

语言模型因其能够对用户的问题生成连贯且令人印象深刻的回答，正越来越受到欢迎。尤其是在用户通过聊天的方式与语言模型交互时，这种方式提供了一种直观的方式来获取所需的信息。

在通过聊天实现语言模型时，一个普遍存在的挑战是所谓的**靠谱程度（groundedness）**，它指的是回应是否有根有据，是否与现实或特定语境相连接。换句话说，扎根性表示语言模型的回应是否基于真实的信息。

## 缺乏依据的提示和回复

当你使用语言模型根据提示词生成回答时，模型所依据的信息仅来自其训练数据 —— 这些数据往往只是来自互联网或其他来源的大量无上下文的文本。
这通常只是从互联网或其他来源来的大量没有上下文的文字内容。


这样的回答通常在语法上是连贯且逻辑合理的，但由于不基于相关的真实数据，它缺乏上下文支持，因此可能是不准确的，甚至包含“虚构”的信息。例如，针对“我应该使用哪个产品来完成 X？”这个问题，模型可能会编造出一个并不存在的产品作为回答。

## 基于事实的提问与回答

相比之下，你可以用一个数据源为提示词提供相关的、真实的背景信息。然后将这个带有背景信息的提示词提交给语言模型，以生成有语境、相关性强、而且更准确的回答。


这个数据源可以是任何相关数据的存储库。例如，你可以使用产品目录数据库中的数据，为“我应该使用哪个产品来完成 X？”这个问题提供依据，使得回答中包含该目录中实际存在产品的相关信息。

在本模块中，你将学习如何通过构建一个使用你自有数据的 Agent，来创建一个具备扎根能力的聊天式语言模型应用。

## 了解如何让你的语言模型基于真实数据生成回答

语言模型擅长生成引人入胜的文本，非常适合作为智能代理（Agent）的基础。代理为用户提供一种直观的基于聊天的应用，帮助他们完成工作。在为特定应用场景设计代理时，你需要确保语言模型具备扎根性，并能使用与用户需求相关的真实信息。

尽管语言模型训练于海量数据，但它们可能无法访问你希望提供给用户的特定知识。为了确保代理基于特定数据，生成准确且贴合领域的回答，你可以使用**检索增强生成（Retrieval Augmented Generation，简称 RAG）**技术。


### 理解 RAG

RAG 是一种可以让语言模型基于事实生成回答的技术。换句话说，它是一种根据用户最初的提示词检索相关信息的过程。一般而言，RAG 模式包括以下几个步骤：
1.根据用户输入的初始提示词检索真实数据；
2.用检索到的真实数据增强提示词内容；
3.利用语言模型生成一个贴合上下文、基于事实的回答。

【1. 用户输入 Prompt】
            │
            ▼
【2. 向向量数据库 / 文档库检索相关内容】
            │
            ▼
【3. 将检索到的真实内容（Grounding Data）拼接进 Prompt】
            │
            ▼
【4. 组合后的 Prompt 一起送入大语言模型（如 GPT-4）】
            │
            ▼
【5. 大语言模型生成结合事实的回答（Grounded Answer）】

通过从指定的数据源中获取上下文信息，可以确保语言模型在回答时使用的是相关的真实资料，而不是单纯依赖它原本的训练数据。RAG 是一种简单易用且非常强大的方法，适用于希望让语言模型“有据可依”、提升生成式 AI 应用回答真实性和准确性的各种场景。

### 向 Azure AI 项目中添加参考资料

你可以使用 Azure AI Foundry 构建一个自定义智能体（agent），它会用你自己的数据来增强提示词的背景信息，让模型生成更准确的回答。包括：

1. Azure Blob 存储
2. Azure Data Lake Storage Gen2
3. Microsoft OneLake

你也可以将文件或文件夹上传到 AI Foundry 项目所使用的存储空间中。

### 让你的数据支持搜索功能

当你希望创建一个能够使用自有数据生成准确回答的智能代理时，就需要具备高效搜索这些数据的能力。在使用 Azure AI Foundry 构建代理时，你可以通过集成 Azure AI Search，在对话流程中检索相关上下文信息。

Azure AI Search 是一种“检索器（retriever）”，可以在使用 Prompt Flow 构建语言模型应用时引入。它支持你导入自己的数据、建立索引，并通过查询索引来获取所需信息。

## 使用向量搜索

虽然基于文本的索引可以提升搜索效率，但通常使用向量索引能实现更优的数据检索效果。这种索引包含了表示你数据源中文本内容的嵌入向量（embedding）。嵌入向量是一种特殊的数据表示格式，搜索引擎可以借助它更容易地找到相关信息。更具体地说，一个嵌入是由多个浮点数值组成的向量。
例如，假设你有两个文档，其内容如下：
"The children played joyfully in the park."
"Kids happily ran around the playground."

这两段文字虽然用词不同，但在语义上是相近的。通过为文本生成向量嵌入，可以用数学方式计算它们之间的语义关系。

你可以想象把这些文档中的关键词提取出来，并在一个多维空间中以向量形式表示：

（此处为“向量嵌入图示”）

不同向量之间的距离可以通过计算它们夹角的余弦值来衡量，这被称为余弦相似度（cosine similarity）。换句话说，余弦相似度可用于衡量文档与查询之间的语义相似性。

通过用向量表示词语及其含义，即便你的数据来源包含不同格式（如文本或图片）或语言，系统也能从中提取出相关的上下文信息。

如果你希望使用向量搜索来查询数据，就需要在创建搜索索引时生成嵌入向量。你可以使用 Azure AI Foundry 中提供的 Azure OpenAI 嵌入模型 来为你的搜索索引生成这些向量。

### 创建搜索索引

在 Azure AI Search 中，搜索索引用于描述你的内容是如何被组织起来以实现可搜索性。可以将其比作一个图书馆，里面有大量书籍。你希望能够轻松、高效地在图书馆中查找并获取相关的书籍。为了让图书馆具备搜索功能，你会创建一个图书目录，其中包含每本书的关键信息，使得任意一本书都能被快速找到。而这个图书目录的作用，就相当于搜索索引。

虽然创建索引的方法有很多种，但由于 Azure AI Foundry 与 Azure AI Search 的深度集成，你可以非常方便地创建一个适用于语言模型的搜索索引。你只需将自己的数据添加到 Azure AI Foundry 中，然后就可以在门户中使用嵌入模型（embedding model）通过 Azure AI Search 来创建索引。这个索引资产会被存储在 Azure AI Search 中，并在对话流程中由 Azure AI Foundry 查询调用。

你如何配置搜索索引，取决于你所拥有的数据类型，以及你希望语言模型使用怎样的上下文信息。

例如，关键词搜索可以让你检索与查询词完全匹配的信息；而语义搜索则更进一步，它使用语义模型来检索与查询含义相符的内容，而不局限于关键词本身。

目前最先进的技术是向量搜索，它通过生成嵌入向量来表示你的数据，从而实现更精准的语义匹配与检索。

https://learn.microsoft.com/en-us/azure/search/vector-search-overview


### 搜索索引

在搜索索引中，有多种方式可以查询信息：

关键词搜索：根据输入的特定关键词或术语，识别相关的文档或内容片段。

语义搜索：通过理解查询的含义，检索与之语义相关的文档或内容，而不仅仅依赖关键词的精确匹配。

向量搜索：利用文本的数学表示（向量）来查找语义含义或上下文相似的文档或内容片段。

混合搜索：结合上述一种或多种搜索技术，同时执行查询，并以统一的结果集返回。

当你在 Azure AI Foundry 中创建搜索索引时，系统会引导你配置一个最适合与语言模型结合使用的索引方式。在生成式 AI 应用中使用搜索结果时，**混合搜索（Hybrid Search）**通常能提供最精准的检索效果。

混合搜索是将关键词搜索（或全文搜索）与向量搜索相结合的方式，并可选地加入语义排序（semantic ranking）。当你创建一个兼容混合搜索的索引时，系统在可以精确匹配时使用关键词搜索，保证高准确性；而在只能找到语义相近内容时，则依靠向量搜索来保持结果的相关性。

## 创建RAG-based 客户端应用程序

当你为上下文数据创建了一个 Azure AI Search 索引后，就可以将其与 OpenAI 模型结合使用。
为了让提示词能够基于索引中的数据进行“扎根”，Azure OpenAI SDK 支持在请求中扩展连接信息，指向该索引。

在使用 Azure AI Foundry 项目时，采用这种方式的使用模式如下图所示。

1. 使用 Azure AI Foundry 项目的客户端，获取 Azure AI Search 索引的连接信息以及一个 OpenAI 的 ChatClient 对象。
2. 将索引的连接信息添加到 ChatClient 的配置中，使其能够根据用户的提示词检索扎根数据。
3. 将带有扎根数据的提示词提交给 Azure OpenAI 模型，以生成具备上下文的回答。

``` csharp
代码

```

在这个示例中，索引的搜索方式是基于关键词的 —— 换句话说，查询内容就是用户提示词中的文本，并与索引文档中的文本进行匹配。而如果使用支持向量搜索的索引，也可以采用另一种方式：基于向量的查询，即通过数值向量来表示文本中的词元（tokens）。

使用向量进行搜索，不仅可以进行字面上的文本匹配，还可以实现基于语义相似性的匹配。

若要使用向量查询，你可以修改 Azure AI Search 数据源配置，添加一个嵌入模型（embedding model），用于将查询文本转换为向量形式进行搜索。

